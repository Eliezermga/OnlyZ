{% extends "base.html" %}

{% block title %}Chat avec {{ other_user.username }} - Onlyz{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white rounded-lg shadow-xl overflow-hidden flex flex-col" style="height: 70vh;">
    <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4 flex items-center">
        <a href="{{ url_for('view_profile', user_id=other_user.id) }}" class="flex items-center flex-1">
            {% if other_user.profile.profile_picture %}
                <img src="{{ url_for('static', filename=other_user.profile.profile_picture) }}" alt="{{ other_user.username }}" class="w-12 h-12 rounded-full object-cover mr-3">
            {% else %}
                <div class="w-12 h-12 rounded-full bg-white text-purple-600 flex items-center justify-center mr-3 font-bold">
                    {{ other_user.username[0].upper() }}
                </div>
            {% endif %}
            <span class="text-xl font-bold">{{ other_user.username }}</span>
        </a>
        <a href="{{ url_for('matches') }}" class="text-white hover:text-gray-200">← Retour</a>
    </div>
    
    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4">
        {% for message in messages %}
            <div class="{% if message.sender_id == current_user.id %}text-right{% else %}text-left{% endif %}">
                <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg {% if message.sender_id == current_user.id %}bg-purple-600 text-white{% else %}bg-gray-200 text-gray-800{% endif %}">
                    {{ message.content }}
                </div>
                <div class="text-xs text-gray-500 mt-1">{{ message.created_at.strftime('%H:%M') }}</div>
            </div>
        {% endfor %}
    </div>
    
    <div class="border-t p-4">
        <form id="message-form" class="flex space-x-2">
            <input type="text" id="message-input" placeholder="Écrivez votre message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
            <button type="submit" class="bg-purple-600 text-white hover:bg-purple-700 px-6 py-2 rounded-lg font-bold">
                Envoyer
            </button>
        </form>
    </div>
</div>

<script>
const socket = io();
const currentUserId = {{ current_user.id }};
const otherUserId = {{ other_user.id }};
const room = `chat_${Math.min(currentUserId, otherUserId)}_${Math.max(currentUserId, otherUserId)}`;

socket.emit('join', { room: room });

document.getElementById('message-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    
    if (content) {
        socket.emit('send_message', {
            receiver_id: otherUserId,
            content: content
        });
        input.value = '';
    }
});

socket.on('receive_message', function(data) {
    const messagesDiv = document.getElementById('messages');
    const isMe = data.sender_id === currentUserId;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = isMe ? 'text-right' : 'text-left';
    
    messageDiv.innerHTML = `
        <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${isMe ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-800'}">
            ${data.content}
        </div>
        <div class="text-xs text-gray-500 mt-1">${new Date(data.created_at).toLocaleTimeString()}</div>
    `;
    
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
</script>
{% endblock %}
